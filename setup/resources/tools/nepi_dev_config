export ACTIVE_CONT=nepi_fs_a
export ACTIVE_VERSION=jetson-3p2p3
export ACTIVE_UPLOAD_DATE=0
export ACTIVE_TAG=3p2p3-CUDA_CV2B
export ACTIVE_ID=f5d05a684202



sudo docker exec -it 668e300abe77 /bin/bash



ID=fcfa41c403c3
NAME=nepi
TAG=3p2p3-jetson-orin
IP_ADDRESS=192.168.179.103

sudo ip addr add 192.168.179.103/24 dev eth0

sudo docker run -it --privileged -e UDEV=1 --user nepi --gpus all \
    --mount type=bind,source=/mnt/nepi_storage,target=/mnt/nepi_storage \
    --mount type=bind,source=/mnt/nepi_config,target=/mnt/nepi_config \
    --mount type=bind,source=/dev,target=/dev \
    --cap-add=SYS_TIME --volume=/var/empty:/var/empty -v /etc/ntpd.conf:/etc/ntpd.conf \
    --net=host \
    --runtime nvidia \
    -v /tmp/.X11-unix/:/tmp/.X11-unix \
    ${NAME}:${TAG} /bin/bash

    --hostname nepi-device1 \
    --publish ${IP_ADDRESS}:80:8080 \


#    --net=host \

sudo docker run -it --privileged -e UDEV=1 --user nepi --gpus all \
    --mount type=bind,source=/mnt/nepi_storage,target=/mnt/nepi_storage \
    --mount type=bind,source=/mnt/nepi_config,target=/mnt/nepi_config \
    --mount type=bind,source=/dev,target=/dev \
    --cap-add=SYS_TIME --volume=/var/empty:/var/empty -v /etc/ntpd.conf:/etc/ntpd.conf \
    --net=host \
    --runtime nvidia \
    -v /tmp/.X11-unix/:/tmp/.X11-unix \
    ${NAME}:${TAG} /bin/bash

    --hostname nepi-device1 \
    --publish ${IP_ADDRESS}:80:8080 \



    # Initialize Run Command
    DOCKER_RUN_COMMAND=" sudo docker run --privileged -e UDEV=1 --user ${USER_NAME} '\'
    --mount type=bind,source=/mnt/nepi_storage,target=/mnt/nepi_storage '\'
    --mount type=bind,source=/mnt/nepi_config,target=/mnt/nepi_config '\'
    --mount type=bind,source=/dev,target=/dev '\'
    -e DISPLAY=${DISPLAY} '\'"
    
    
    # Set Remove Mode
    if [[ ! -v RM_MODE || ( -v RM_MODE && "$RM_MODE" -eq 1 ) ]]; then
        echo "Setting Remove Mode TRUE"
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --rm '\'"
    fi 
    
    # Set Interactive Mode
    if [[ ! -v IT_MODE || ( -v IT_MODE && "$IT_MODE" -eq 1 ) ]]; then
        echo "Setting Interactive Mode TRUE"
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --it '\'"
    fi 
    
    
    # Set Clock Settings
    if [[ "$MANAGES_CLOCK" -eq 1 ]]; then
        echo "Disabling Host Auto Clock Updating"
        sudo timedatectl set-ntp no
    
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --cap-add=SYS_TIME --volume=/var/empty:/var/empty -v /etc/ntpd.conf:/etc/ntpd.conf '\'"
    
    fi 
    
    
    # Update Network Settings
    echo "Setting Static IP"
    echo "IP_ADDRESS"
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --net=host '\'
    --hostname ${DEVICE_ID} '\'
    --network my_custom_network --ip ${NEPI_IP_ADDRESS} '\'"
    
    
    if [[ LENGTH OF $IP_ALIASES > 0 ]]; then
        echo "Adding IP Aliases"
        echo $IP_ALIASES
    
    
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --net=host '\'
    
    "
    
    fi 
    
    
    # Set cuda support if needed
    if [[ "$DEVICE_ID" == "JETSON" ]]; then
        echo "Enabling Jetson GPU Support TRUE"
    
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    --gpus all '\'
    --runtime nvidia '\'
    -v /tmp/.X11-unix/:/tmp/.X11-unix '\'"
    
    fi 
    
    
    
    
    # Finish Run Command
    DOCKER_RUN_COMMAND="${DOCKER_RUN_COMMAND}
    ${ACTIVE_CONT}:${ACTIVE_TAG} /bin/bash '\'
    -c '/opt/nepi/scripts/nepi_start_all.sh'"   


ID=94fe8acffce7 
sudo docker exec -it $ID /bin/bash

ID=668e300abe77 
sudo docker start -ai $ID

sudo docker commit $ID ${NAME}:${TAG}