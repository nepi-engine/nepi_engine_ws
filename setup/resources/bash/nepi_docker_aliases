#!/bin/bash

##
## Copyright (c) 2024 Numurus, LLC <https://www.numurus.com>.
##
## This file is part of nepi-engine
## (see https://github.com/nepi-engine).
##
## License: 3-clause BSD, see https://opensource.org/licenses/BSD-3-Clause
##



NCFG=/home/${USER}/.nepi_config
source $NCFG
wait

NUSH=/home/${USER}/.nepi_bash_utils
source $NUSH
wait
UINFO="$(. ${NUSH} && utilsn)"


# This file contains nepi docker host system aliases and sources nepi bash utils
HELPN="
#############################
## NEPI Help Info ##
#############################"

########################
# Variable Initailization
#########################


# Function to update aliases from config file call same function when changes are made to the onfig file
function refresh_nepi(){
    . ${NEPI_DOCKER_CONFIG}/refresh_nepi_docker.sh
}

export -f refresh_nepi

refresh_nepi
wait
#############################
# NEPI DOCKER FUNCTIONS
#############################


function create_tag(){
    refresh_nepi
  wait
    SW_VERSION=$1
    HW_TYPE=$2
    HW_MODEL=$3
    
    TAG_VARIABLE=$4
    tag=${SW_VERSION}-${HW_TYPE}-${HW_MODEL}
    export TAG_VARIABLE="${tag,,}" # Convert to lowercase
    echo "$TAG_VARIABLE"
}
export -f create_tag



######################
# RUN_NEPI
######################
function run_nepi(){
    #Run NEPI in Normal Mode
    export IT_MODE=0
    export REMOVE_MODE=1
    . ${NEPI_DOCKER_CONFIG}/start_nepi_docker.sh
}
export -f run_nepi


######################
# RUN_DEV
######################
function run_nepi_dev(){
    #Run NEPI in Dev Mode
    export IT_MODE=1
    export REMOVE_MODE=0
    . ${NEPI_DOCKER_CONFIG}/start_nepi_docker.sh
}
export -f run_nepi_dev


######################
# COMMIT_NEPI
######################
function commit_nepi(){
    # Commit the Running Container
    if [[ ! -v RUNNING ]]; then
        if [[ ( -v RUNNING && "$RUNNING" -eq 1 ) ]]; then
            echo "Stopping Running NEPI Docker Process ${RUNNING_CONT}:${RUNNING_TAG} ID:${RUNNING_ID}"
            dcommit $RUNNING_ID ${1}:${2}
        else
            echo "No Running NEPI Contatainer to Commit"
        fi
    else
        echo "Failed to Read NEPI Docker Config File"
        exit 1
    fi 
}
export -f commit_nepi

######################
# LOGIN_NEPI
######################
function login_nepi(){
    # Connect to the Running Container
    if [[ ! -v RUNNING ]]; then
        if [[ ( -v RUNNING && "$RUNNING" -eq 1 ) ]]; then
            echo "Stopping Running NEPI Docker Process ${RUNNING_CONT}:${RUNNING_TAG} ID:${RUNNING_ID}"
            dlogin $RUNNING_ID
        else
            echo "No Running NEPI Contatainer to Log Into"
        fi
    else
        echo "Failed to Read NEPI Docker Config File"
        exit 1
    fi 
    
}
export -f login_nepi

######################
# SWITCH_NEPI
######################
function switch_nepi(){
  . ${NEPI_DOCKER_CONFIG}/swtich_nepi_docker.sh

}
export -f switch_nepi

######################
# IMPORT_NEPI
######################

function import_nepi(){
  refresh_nepi
  wait

  IMPORT_PATH=$IMPORT_PATH
  echo $IMPORT_PATH
  ###### NEED TO GET LIST OF AVAILABLE TARS and Select Image
  #IMAGE_FILE=nepi-jetson-3p2p0-rc2.tar
  IMAGE_FILE=$1
  echo $IMAGE_FILE
  ######  NEED TO: Update from IMPORT_PATH tar file
  IMAGE_VERSION=3p2p0
  echo $IMAGE_VERSION
  ######
  #INSTALL_IMAGE=${IMPORT_PATH}/${IMAGE_FILE}
  INSTALL_IMAGE=${EXPORT_PATH}/''${IMAGE_FILE}
  echo $INSTALL_IMAGE
  #1) Stop any processes for INACTIVE_CONT
  #docker stop ${RUNNING_CONT}
  #2) Import INSTALL_IMAGE to STAGING_CONT
  res=$(sudo docker import $INSTALL_IMAGE)
  echo $res
  #3) Remove INACTIVE_CONT
  #docker stop ${ACTIVE_CONT}
  #4) Rename STAGING_CONT to INACTIVE_CONT
  hash=${res##*sha256:}
  echo $hash
  ID=${hash:0:12}
  echo $ID
  NEW_DATE=$(date +%Y-%m-%d)
  echo $NEW_DATE
  NEW_NAME=$INACTIVE_CONT
  echo $NEW_NAME
  NEW_TAG=$INACTIVE_TAG
  printf 'Create a Custom Tag (y/n)? '
  read answer
  if [ "$answer" != "${answer#[Yy]}" ] ;then 
      echo 'Enter Custom Tag: ' 
      read CUSTOM_TAG
      NEW_TAG=$CUSTOM_TAG
      echo ''
  else
      echo ''
  fi
  NEW_VERSION=$IMAGE_VERSION
  printf 'Create a Custom Version (y/n)? '
  read answer
  if [ "$answer" != "${answer#[Yy]}" ] ;then 
      echo 'Enter Custom Version: ' 
      read CUSTOM_TAG
      NEW_TAG=$CUSTOM_TAG
      echo ''
  else
      echo ''
  fi


  sudo docker tag $ID ${NEW_NAME}:${NEW_TAG}
  #6) Update inactive version,tags,ids in nepi_docker_config.yaml
  update_yaml_value "INACTIVE_VERSION" "$INACTIVE_VERSION" "$NEPI_DOCKER_CONFIG_FILE"
  update_yaml_value "INACTIVE_UPLOAD_DATE" "$NEW_DATE" "$NEPI_DOCKER_CONFIG_FILE"
  update_yaml_value "INACTIVE_TAG" "$NEW_TAG" "$NEPI_DOCKER_CONFIG_FILE"
  update_yaml_value "INACTIVE_ID" "$NEW_VERSION" "$NEPI_DOCKER_CONFIG_FILE"
  echo "  ADD SOME PRINT OUTS  "
  refresh_nepi
  wait
}
export -f import_nepi

######################
# EXPORT_NEPI
######################

function export_nepi(){
  refresh_nepi
  wait
  #echo $RUNNING_CONT
  RUN_NAME=$1
  echo $RUN_NAME
  RUN_ID=$2
  echo $RUN_ID
  if [[ "$RUN_NAME" != "None" ]]; then
    TAR_EXPORT_PATH=${EXPORT_PATH}/''${RUN_NAME}.tar
    #echo $TAR_EXPORT_PATH
    sudo docker export $RUN_ID > $TAR_EXPORT_PATH
  else
    echo "No Running Container"
  fi
}
export -f export_nepi


function ffile(){
    yq e -i '.' nepi_docker_config.yaml 
}
export -f ffile




###################################
# NEPI SSH Agent Config
###################################

CURRENT_DIR=$(pwd)

export NEPI_SSH_KEY_PATH=~/ssh_keys/nepi_engine_default_private_ssh_key

export NEPI_REMOTE_SETUP=1
export NEPI_TARGET_IP=192.168.179.103
export NEPI_TARGET_USERNAME=nepi
export NEPI_SSH_KEY=~/ssh_keys/nepi_engine_default_private_ssh_key
export NEPI_TARGET_SRC_DIR=/mnt/nepi_storage/nepi_src # This is the default if unset

# Setup Connection Shortcuts
alias sshn="ssh -o StrictHostKeyChecking=no -i $NEPI_SSH_KEY_PATH nepi@nepi"
alias scpn="scp -o StrictHostKeyChecking=no -i $NEPI_SSH_KEY_PATH nepi@nepi"
alias sftpn="sftp -o StrictHostKeyChecking=no -i $NEPI_SSH_KEY_PATH nepi@nepi"


SSH_ENV="$HOME/.ssh/environment"

function run_ssh_env {
  . "${SSH_ENV}" > /dev/null
}

function start_ssh_agent {
  echo "Initializing new SSH agent..."
  ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
  echo "succeeded"
  chmod 600 "${SSH_ENV}"

  run_ssh_env;

  ssh-add ~/.ssh/id_rsa;
}

if [ -f "${SSH_ENV}" ]; then
  run_ssh_env;
  ps -ef | grep ${SSH_AGENT_PID} | grep ssh-agent$ > /dev/null || {
    start_ssh_agent;
  }
else
  start_ssh_agent;
fi



###################################
###################################
#NEPI folder shortcuts
export AI="/mnt/nepi_storage/ai_models"
export AIF="/opt/nepi/nepi_engine/share/nepi_ai_ifs"
export API="/opt/nepi/nepi_engine/lib/python3/dist-packages/nepi_api"
export APPS="/opt/nepi/nepi_engine/share/nepi_apps"
export AUTO="/mnt/nepi_storage/automation_scripts"
export DATA="/mnt/nepi_storage/data"
export DIST="/opt/nepi/nepi_engine/lib/python3/dist-packages"
export DRIVERS="/opt/nepi/nepi_engine/lib/nepi_drivers"
export ENGINE="/opt/nepi/nepi_engine"
export ETC="/opt/nepi/nepi_engine/etc"
export INSTALL="/mnt/nepi_storage/intstall"
export LAUNCH="/opt/nepi/nepi_engine/share/nepi_env/launch"
export LIB="/opt/nepi/nepi_engine/lib"
export LIBSDK="/opt/nepi/nepi_engine/lib/nepi_sdk"
export MANAGERS="/opt/nepi/nepi_engine/lib/nepi_managers"
export NEPI="/opt/nepi"
export NFI="/mnt/nepi_storage/nepi_full_img"
export NFIA="/mnt/nepi_storage/nepi_full_img_archive"
export RUI="/opt/nepi/nepi_rui/src/rui_webserver/rui-app/src"
export RUI_ENV="/opt/nepi/nepi_rui"
export SDK="/opt/nepi/nepi_engine/lib/python3/dist-packages/nepi_sdk"

export SHARE="/opt/nepi/nepi_engine/share"
export SRC="/mnt/nepi_storage/nepi_src/nepi_engine_ws/src"
export SRCRUI="/mnt/nepi_storage/nepi_src/nepi_engine_ws/src/nepi_rui/src/rui_webserver/rui-app/src"
export TMP="/mnt/nepi_storage/tmp"
export DRIVE="/mnt/nepi_storage"



#NEPI sftp folder shortcuts
# Function to open sftp to location on nepi device
# Example call: sftpnl '/mnt/nepi_storage'
function sftpnl(){
sftp -o StrictHostKeyChecking=no -i $NEPI_SSH_KEY_PATH nepi@nepi:../.."$@"
}
function ai(){
	sftpnl $AI
}	
function aifs(){
	sftpnl $AIFS
}	
function api(){
	sftpnl $API
}	
function apps(){
	sftpnl $APPS
}
function auto(){
	sftpnl $AUTO
}
function data(){
	sftpnl $DATA
}	
function dist(){
	sftpnl $DIST
}	
function drivers(){
	sftpnl $DRIVERS
}	
function engine(){
	sftpnl $ENGINE
}
function etc(){
	sftpnl $ETC
}	
function intstall(){
	sftpnl $INSTALL
}	
function lib(){
	sftpnl $LIB
}	
function libsdk(){
	sftpnl $LIBSDK
}	
function managers(){
	sftpnl $MANAGERS
}	
function nepi(){
	sftpnl $NEPI
}	
function nfi(){
	sftpnl $NFI
}	
function nfia(){
	sftpnl $NFIA
}	
function rui(){
	sftpnl $RUI
}
function rui_env(){
	sftpnl $RUI_ENV
}	
function sdk(){
	sftpnl $SDK
}	
function share(){
	sftpnl $SHARE
}	
function src(){
	sftpnl $SRC
}	
function srcrui(){
	sftpnl $SRCRUI
}
function tmp(){
	sftpnl $TMP
}	
function drive(){
	sftpnl $DRIVE
}


export FCFG="/mnt/nepi_config/factory_cfg"
export SCFG="/mnt/nepi_config/system_cfg"
export UCFG="/mnt/nepi_storage/user_cfg"

function fcfg(){
	sftpnl $FCFG
}	

function scfg(){
	sftpnl $SCFG
}	

function ucfg(){
	sftpnl $UCFG
}	

# Print out the nepi shortcuts
function helpn(){
    HELPN="${UINFO}

################################
## NEPI sftp folder shortcuts ##
################################
drive = /mnt/nepi_storage

ai = /mnt/nepi_storage/ai_models
aifs = /opt/nepi/nepi_engine/share/nepi_aifs
api = /opt/nepi/nepi_engine/lib/python3/dist-packages/nepi_api
apps = /opt/nepi/nepi_engine/share/nepi_apps
auto = /mnt/nepi_storage/automation_scripts
data = /mnt/nepi_storage/data
dist = /opt/nepi/nepi_engine/lib/python3/dist-packages/
drivers = /opt/nepi/nepi_engine/lib/nepi_drivers
engine = /opt/nepi/nepi_engine
etc = /opt/nepi/nepi_engine/etc
intstall = /mnt/nepi_storage/intstall
lib = /opt/nepi/nepi_engine/lib
libsdk = /opt/nepi/nepi_engine/lib/sdk
managers = /opt/nepi/nepi_engine/lib/nepi_managers
nepi = /opt/nepi
nfi = /mnt/nepi_storage/nepi_full_img
nfia = /mnt/nepi_storage/nepi_full_img_archive
rui = /opt/nepi/rui/src/rui_webserver/rui-app/src
rui_env = /opt/nepi/rui
sdk = /opt/nepi/nepi_engine/lib/python3/dist-packages/nepi_sdk
share = /opt/nepi/nepi_engine/share
src = /mnt/nepi_storage/nepi_src/nepi_engine_ws/src
srcrui = /mnt/nepi_storage/nepi_src/nepi_engine_ws/src/nepi_rui/src/rui_webserver/rui-app/src
tmp = /mnt/nepi_storage/tmp

fcfg = /mnt/nepi_config/factory_cfg
scfg = /mnt/nepi_config/system_cfg
ucfg = /mnt/nepi_storage/user_cfg"
}

export SETUPN="${NEPI_SOURCE}/nepi_engine_ws/setup"
alias setupn="cd ${SETUPN}"

# Print out the nepi shortcuts
function helpn(){
    HELPN="${UINFO}

################################
## NEPI folder shortcuts ##
################################

setupn = ${NEPI_SOURCE}/nepi_engine_ws/setup"
    echo "$HELPN"
}


export NEPI_REMOTE_SETUP=0


